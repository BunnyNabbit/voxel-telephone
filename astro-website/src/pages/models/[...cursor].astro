---
import ContentPage from "../../layouts/ContentPage.astro"
import Turn from "../../components/Turn.astro"
import { database } from "../../shared/db.mjs"
// @ts-ignore
import { ObjectId } from "mongodb"
let cursor, nextCursor, previousCursor
if (Astro.params.cursor) cursor = ObjectId.createFromHexString(Astro.params.cursor)
let licensedGrid = []
licensedGrid = await database.getLicensedGrid(cursor)
licensedGrid = licensedGrid.flat(1)
if (licensedGrid.length == 65 * 2) {
	nextCursor = licensedGrid[licensedGrid.length - 3]._id
	licensedGrid.pop()
	licensedGrid.pop()
}
// Check if there's a previous page
if (cursor && licensedGrid.length > 0) {
	// Find the first build turn in the grid
	const firstBuildTurn = licensedGrid.find((turn) => turn && turn.promptType === "build")
	if (firstBuildTurn) {
		const firstItemId = firstBuildTurn._id
		// Query for items with _id > firstItemId to find the previous page cursor
		const findDocument = { promptType: "build", licenses: { $exists: true }, _id: { $gt: firstItemId } }
		// Fetch items going backwards to find the right cursor - we need one full page (65 items)
		const previousPageItems = await database.gameCollection.find(findDocument).sort({ _id: 1 }).limit(65).toArray()
		if (previousPageItems.length > 0) {
			// If we have a full page or more, use the last item as cursor for previous page
			// If we have less than a full page, we should go to the first page (no cursor)
			if (previousPageItems.length >= 65) {
				previousCursor = previousPageItems[previousPageItems.length - 1]._id
			} else {
				// Use empty string to indicate first page (no cursor)
				previousCursor = ""
			}
		}
	}
}
---

<ContentPage title="Models" description="Free downloadable 3D voxel models in MagicaVoxel format.">
	<p>Free downloadable 3D voxel models in MagicaVoxel format.</p>
	<div class="flex-container">
		{
			licensedGrid.map((turn: any, index: number) => {
				if (turn.promptType === "description") {
					return null
				}
				return <Turn description={licensedGrid[index - 1]} build={turn} rootId={turn.root} anchor={`#${turn.depth}`} asModel={true} />
			})
		}
	</div>
	<div class="flex-container">
		{
			previousCursor !== null && (
				<a href={previousCursor === "" ? `/models` : `/models/${previousCursor}`} class="pagination-button">
					Previous Page
				</a>
			)
		}
		{
			nextCursor && (
				<a href={`/models/${nextCursor}`} class="pagination-button">
					Next Page
				</a>
			)
		}
	</div>
</ContentPage>
