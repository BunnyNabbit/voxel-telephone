---
import { database } from "../../../shared/db.mjs"
import ContentPage from "../../../layouts/ContentPage.astro"
import { Image } from "astro:assets"
import Turn from "../../../components/Turn.astro"
import Timestamp from "../../../components/Timestamp.astro"
import PaginationButtons from "../../../components/PaginationButtons.astro"
import { ObjectId } from "mongodb"
import { getPaginationCursors } from "../../../shared/pagination.mjs"

const username = Astro.params.username
let cursor, nextCursor, previousCursor
if (Astro.params.cursor) cursor = ObjectId.createFromHexString(Astro.params.cursor)
const userRecord = await database.getUserRecordDocument(username, true)
let title = username
let userGrid = []
if (!userRecord) {
  title = "Player not found"
  Astro.response.status = 404
} else {
  if (userRecord.displayName) title = userRecord.displayName
  userGrid = await database.getUserGrid(username, cursor)
  userGrid = userGrid.flat(1)
	const { nextCursor: nc, previousCursor: pc } = await getPaginationCursors({
		dataArray: userGrid,
		currentCursor: cursor,
		pageSize: 65,
		findFirstItem: (turn) => turn && turn.promptType === "build",
		buildPreviousQuery: (firstItemId) => ({ promptType: "build", creators: username, _id: { $gt: firstItemId } }),
		collection: database.gameCollection
	});
	nextCursor = nc;
	previousCursor = pc;
}
---

<ContentPage title={title} description={`Builds by ${username}`} ogImage={{url: `https://www.classicube.net/face/${username}/`, alt: `Head shot of ${username}`}}>
	{
		userRecord ? (
			<Image src={`https://www.classicube.net/face/${username}/`} alt={`Head shot of ${username}`} width="128" height="128" />
			<p>First joined: <Timestamp date={userRecord.firstJoin} /></p>
		) : (
			<p>Player not found.</p>
		)
	}
	{
		userGrid.length > 0 ? (
			<h2>Builds</h2>
			<div class="flex-container ">
				{
					userGrid.map((turn: any, index: number) => {
						if (turn.promptType === "description") return null
						return (
							<Turn description={userGrid[index - 1]} build={turn} rootId={turn.root} anchor={`#${turn.depth}`} />
						)
					})
				}
			</div>
		) : (
			<p></p>
		)
	}
	   <PaginationButtons previousCursor={previousCursor} nextCursor={nextCursor} basePath="/player/[username]" username={username} />
</ContentPage>
